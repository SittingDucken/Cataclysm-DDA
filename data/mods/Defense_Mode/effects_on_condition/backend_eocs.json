[
  {
    "type": "effect_on_condition",
    "id": "scenario_defense_mode",
    "deactivate_condition": { "math": [ "wave_number >= 1" ] },
    "effect": [
      { "math": [ "diffulty_modifier = 1" ] },
      { "math": [ "wave_money_modifier = -1000" ] },
      { "open_dialogue": { "topic": "TALK_DEFENSE_MODE_MAIN_MENU" } },
      { "mapgen_update": "faction_start_add_dm" }
    ]
  },
  {
    "type": "mapgen",
    "update_mapgen_id": "faction_start_add_dm",
    "object": {
      "faction_owner": [ { "id": "your_followers", "x": [ 1, 23 ], "y": [ 1, 23 ] } ],
      "place_npcs": [ { "class": "your_follower_base_setup", "x": 10, "y": 10 } ],
      "place_nested": [ { "chunks": [ "4x4_dm_tools" ], "x": [ 3 ], "y": [ 3 ] } ]
    }
  },
  {
    "type": "npc",
    "id": "your_follower_base_setup_dm",
    "//": "Scenario specific, should not spawn outside of trigger events.  Workaround to start a faction camp",
    "class": "NC_BOUNTY_HUNTER",
    "attitude": 1,
    "mission": 0,
    "chat": "TALK_DEFENSE_MODE_MAIN_MENU",
    "faction": "no_faction"
  },
  {
    "type": "mapgen",
    "nested_mapgen_id": "4x4_dm_tools",
    "object": {
      "mapgensize": [ 4, 4 ],
      "rows": [
        "   2",
        "   2",
        "   2",
        "!222"
      ],
      "palettes": [ "shelter_unfinished" ],
      "furniture": { "!": "f_crate_o", "2": "f_crate_o" },
      "items": {
        "!": [
          { "item": "dm_tools", "chance": 100, "faction": "your_followers" },
          { "item": "dm_steel_plating", "chance": 100, "faction": "your_followers" }
        ],
        "2": [
          { "item": "faction_camp_misc", "chance": 80, "repeat": [ 1, 2 ], "faction": "your_followers" },
          { "item": "trash_junkyard", "chance": 80, "repeat": [ 6, 9 ], "faction": "your_followers" },
          { "item": "tools_home", "chance": 95, "faction": "your_followers" },
          { "item": "dishes_utility", "chance": 80, "repeat": [ 2, 3 ], "faction": "your_followers" }
        ]
      }
    }
  },
  {
    "id": "dm_tools",
    "type": "item_group",
    "//": "Tools commonly found in the home or other domestic settings",
    "items": [
      {
        "collection": [
          { "item": "oxy_torch", "prob": 100 },
          {
            "distribution": [
              { "item": "weldtank", "prob": 100, "count": [ 1, 2 ] },
              { "item": "tinyweldtank", "prob": 100, "count": [ 1, 3 ] },
              { "item": "smallweldtank", "prob": 100, "count": [ 1, 3 ] }
            ],
            "prob": 100
          }
        ],
        "prob": 100
      }
    ]
  },
  {
    "id": "dm_steel_plating",
    "type": "item_group",
    "//": "Steel plating to kickoff defense mode",
    "items": [ { "item": "steel_plate", "prob": 100, "count": [ 32, 48 ] } ]
  },
  {
    "type": "effect_on_condition",
    "id": "defense_mode_game_start_final_setup",
    "//": "This is what really starts the game for the player.",
    "effect": [
      { "u_message": "Get ready for the first wave, it's not that far away!", "type": "good", "popup": true },
      { "run_eocs": "DEFENSE_MODE_WAVE_CONTROL" }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "defense_mode_caravan_spawn",
    "recurrence": [ "2 days", "4 days" ],
    "global": true,
    "condition": { "math": [ "u_monsters_nearby('radius': u_search_radius == 3) <= 0" ] },
    "effect": [
      { "u_spawn_npc": "defense_mode_merchant", "lifespan": "2 hours", "real_count": 1, "min_radius": 2, "max_radius": 3 },
      { "u_message": "A caravan approaches!", "type": "good", "popup": false }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "defense_mode_hire_merc_true",
    "global": true,
    "effect": [ { "u_spawn_npc": "follower_mercenary", "real_count": 1, "min_radius": 2, "max_radius": 3 } ]
  },
  {
    "type": "effect_on_condition",
    "id": "defense_mode_money_add_npc",
    "global": false,
    "condition": { "not": { "compare_string": [ "yes", { "npc_val": "general_trade_u_got_money" } ] } },
    "effect": [
      { "u_spend_cash": { "math": [ "wave_number * wave_money_modifier" ] } },
      { "npc_add_var": "general_trade_u_got_money", "value": "yes" }
    ]
  },
  {
    "type": "effect_on_condition",
    "id": "DEFENSE_MODE_FORTRESS_TRAP",
    "//": "Keeps you from running away from your hideout.",
    "global": true,
    "recurrence": 100,
    "condition": {
      "or": [
        { "u_near_om_location": "field", "range": 0 },
        { "u_near_om_location": "forest", "range": 0 },
        { "u_near_om_location": "forest_thick", "range": 0 },
        { "u_near_om_location": "lake_shore", "range": 0 },
        { "u_near_om_location": "lake_surface", "range": 0 }
      ]
    },
    "effect": [
      { "u_message": "You can't leave your fortress behind!", "type": "bad", "popup": false },
      { "u_teleport": { "global_val": "your_spawnpoint" } }
    ]
  },
  {
    "id": "EOC_DEFENSE_MODE_PREVENT_DEATH",
    "type": "effect_on_condition",
    "eoc_type": "PREVENT_DEATH",
    "condition": { "math": [ "revivication_counter >= 1" ] },
    "effect": [
      { "u_lose_effect": [ "hypovolemia", "redcells_anemia", "grabbed", "staggered", "bite", "bleed" ] },
      { "math": [ "u_calories() = u_calories()" ] },
      { "math": [ "u_val('pkill') = u_val('pkill')" ] },
      { "math": [ "u_val('stim') = u_val('stim')" ] },
      { "math": [ "u_pain() = 0" ] },
      { "math": [ "u_val('sleepiness') = 0" ] },
      { "math": [ "u_val('stamina') = 8500" ] },
      { "math": [ "revivication_counter--" ] },
      { "u_cast_spell": { "id": "remove_opponents" } },
      {
        "u_message": "For an instant that is also an eternity, you exist only in an empty void.  Then you feel something vast, alien, and merciless reach through a preexisting connection to give you just enough energy to exist.  Its motives for doing so are not likely to be benign.",
        "popup": true
      },
      { "math": [ "u_hp('torso') = max( u_hp('torso'), 100)" ] },
      { "math": [ "u_hp('head') = max( u_hp('head'), 100)" ] },
      { "math": [ "u_hp('arm_l') = max( u_hp('arm_l'), 100)" ] },
      { "math": [ "u_hp('arm_r') = max( u_hp('arm_r'), 100)" ] },
      { "math": [ "u_hp('leg_l') = max( u_hp('leg_l'), 100)" ] },
      { "math": [ "u_hp('leg_r') = max( u_hp('leg_r'), 100)" ] }
    ]
  }
]
